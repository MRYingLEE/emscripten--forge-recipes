context:
  name: pymupdf
  version: "1.26.3"

package:
  name: ${{ name }}
  version: ${{ version }}

source:
- url: https://pypi.io/packages/source/${{ name[0] }}/${{ name }}/${{ name|replace('-','_') }}-${{ version }}.tar.gz
  sha256: b7d2c3ffa9870e1e4416d18862f5ccd356af5fe337b4511093bbbce2ca73b7e5

build:
  number: 0
  script: |
    # Configure PyMuPDF for WebAssembly build
    export PYMUPDF_SETUP_FLAVOUR=pb
    export PYMUPDF_SETUP_MUPDF_TESSERACT=0
    export HAVE_LIBCRYPTO=no
    export USE_ZXINGCPP=0
    export PYMUPDF_SETUP_MUPDF_BARCODE=0
    
    # Patch PyMuPDF to disable barcode support for WebAssembly
    find . -name "*.py" -type f -exec sed -i 's/barcode=yes/barcode=no/g' {} \;
    find . -name "*wrap*" -type f -exec sed -i 's/barcode=yes/barcode=no/g' {} \;
    find . -name "setup.py" -type f -exec sed -i 's/barcode=yes/barcode=no/g' {} \;
    
    # Set TOFU flags to disable external dependencies  
    export XCFLAGS="-DTOFU -DTOFU_CJK -DTOFU_CJK_EXT -DTOFU_CJK_LANG -DTOFU_EMOJI -DTOFU_HISTORIC -DTOFU_SYMBOL -DTOFU_SIL -DTOFU_BASE14 -DTOFU_NOTO -DFZ_ENABLE_ICC=0 -DFZ_ENABLE_BROTLI=0 -DFZ_ENABLE_JPX=0 -DNO_HARFBUZZ"
    export XCXXFLAGS="-DTOFU -DTOFU_CJK -DTOFU_CJK_EXT -DTOFU_CJK_LANG -DTOFU_EMOJI -DTOFU_HISTORIC -DTOFU_SYMBOL -DTOFU_SIL -DTOFU_BASE14 -DTOFU_NOTO -DFZ_ENABLE_ICC=0 -DFZ_ENABLE_BROTLI=0 -DFZ_ENABLE_JPX=0 -DNO_HARFBUZZ"
    
    ${{ PYTHON }} -m pip install . ${{ PIP_ARGS }} -v

requirements:
  build:
    - ${{ compiler('cxx') }}
    - cross-python_${{ target_platform }}
    - python
    - pip
    - git
  host:
    - python ${{ python }}
    - pip ${{ pip }}
    - setuptools
    - zlib
    - freetype
    - libjpeg-turbo
  run:
    - python

tests:
- script: pytester
  files:
    recipe:
    - test_import_pymupdf.py

about:
  homepage: https://github.com/pymupdf/PyMuPDF
  summary: 'Python bindings for MuPDF PDF library'
  description: |
    PyMuPDF is a Python binding for the MuPDF PDF and XPS library.
    This build is optimized for WebAssembly with all embedded fonts disabled,
    and ICC color management and Brotli compression disabled for compatibility.
  license: AGPL-3.0-or-later
  license_family: GPL
  license_file: COPYING
  documentation: https://pymupdf.readthedocs.io/
  repository: https://github.com/pymupdf/PyMuPDF

extra:
  recipe-maintainers:
  - Copilot